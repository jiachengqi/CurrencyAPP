
#include <gtest/gtest.h>
#include "../CurrencyApp.hpp"


TEST(JsonParseTest, JsonParsing) {

    json j = json::parse(
            R"({"success":true,"timestamp":1626952503,"base":"EUR","date":"2021-07-22","rates":{"AED":4.33091,"AFN":93.783272,"ALL":122.345029,"AMD":575.304717,"ANG":2.117125,"AOA":754.447108,"ARS":113.637215,"AUD":1.59836,"AWG":2.122893,"AZN":2.002636,"BAM":1.95639,"BBD":2.381511,"BDT":100.012118,"BGN":1.957612,"BHD":0.444554,"BIF":2337.189167,"BMD":1.179058,"BND":1.604398,"BOB":8.144121,"BRL":6.117773,"BSD":1.179538,"BTC":3.7147313e-5,"BTN":87.704164,"BWP":13.025809,"BYN":2.963148,"BYR":23109.528554,"BZD":2.377481,"CAD":1.480619,"CDF":2361.652105,"CHF":1.082463,"CLF":0.032163,"CLP":887.488095,"CNY":7.624849,"COP":4546.963289,"CRC":731.249366,"CUC":1.179058,"CUP":31.245026,"CVE":110.295176,"CZK":25.649248,"DJF":209.98012,"DKK":7.438108,"DOP":67.346712,"DZD":158.678532,"EGP":18.477837,"ERN":17.690874,"ETB":52.254961,"EUR":1,"FJD":2.456979,"FKP":0.852177,"GBP":0.857094,"GEL":3.666837,"GGP":0.852177,"GHS":7.023822,"GIP":0.852177,"GMD":60.246252,"GNF":11536.556295,"GTQ":9.14104,"GYD":246.76856,"HKD":9.163965,"HNL":28.017547,"HRK":7.531582,"HTG":111.461022,"HUF":358.286173,"IDR":17087.550921,"ILS":3.856474,"IMP":0.852177,"INR":87.817446,"IQD":1720.827018,"IRR":49644.219291,"ISK":147.99541,"JEP":0.852177,"JMD":182.061178,"JOD":0.835969,"JPY":129.996989,"KES":127.621561,"KGS":99.49395,"KHR":4802.791797,"KMF":492.079783,"KPW":1061.151829,"KRW":1353.428813,"KWD":0.354684,"KYD":0.982944,"KZT":502.856915,"LAK":11255.593039,"LBP":1783.342531,"LKR":235.301789,"LRD":202.385863,"LSL":17.154929,"LTL":3.48145,"LVL":0.7132,"LYD":5.321724,"MAD":10.564525,"MDL":21.360816,"MGA":4475.701451,"MKD":61.631862,"MMK":1941.387449,"MNT":3358.091069,"MOP":9.441643,"MRO":420.923353,"MUR":50.818137,"MVR":18.144563,"MWK":954.849386,"MXN":23.776405,"MYR":4.979222,"MZN":74.999887,"NAD":17.154997,"NGN":485.358922,"NIO":41.411857,"NOK":10.390633,"NPR":140.326822,"NZD":1.69259,"OMR":0.453987,"PAB":1.179538,"PEN":4.653555,"PGK":4.141328,"PHP":59.045433,"PKR":189.715777,"PLN":4.57433,"PYG":8125.71637,"QAR":4.292915,"RON":4.923982,"RSD":117.637184,"RUB":87.066302,"RWF":1176.586872,"SAR":4.422585,"SBD":9.489472,"SCR":19.078595,"SDG":526.454421,"SEK":10.231178,"SGD":1.603802,"SHP":0.852177,"SLL":12091.235786,"SOS":689.748706,"SRD":25.122174,"STD":24288.378657,"SVC":10.320955,"SYP":1482.50661,"SZL":17.173517,"THB":38.755733,"TJS":13.451909,"TMT":4.126702,"TND":3.281905,"TOP":2.666671,"TRY":10.08295,"TTD":8.003724,"TWD":33.024582,"TZS":2734.726233,"UAH":32.066581,"UGX":4184.89819,"USD":1.179058,"UYU":51.795853,"UZS":12501.149239,"VEF":252118144326.16608,"VND":27141.735133,"VUV":129.836289,"WST":3.008549,"XAF":656.119814,"XAG":0.047066,"XAU":0.000657,"XCD":3.186462,"XDR":0.830706,"XOF":656.136513,"XPF":119.732941,"YER":294.941445,"ZAR":17.167538,"ZMK":10612.934165,"ZMW":26.096472,"ZWL":379.656822}})");
    json jj = json::parse(
            R"({"success":true,"timestamp":1627021804,"base":"EUR","date":"2021-07-23","rates":{"AED":4.323677,"AFN":93.705162,"ALL":122.237945,"AMD":574.796295,"ANG":2.115353,"AOA":753.230425,"ARS":113.479853,"AUD":1.596794,"AWG":2.118881,"AZN":2.005845,"BAM":1.954678,"BBD":2.379497,"BDT":99.928396,"BGN":1.95598,"BHD":0.443802,"BIF":2335.163342,"BMD":1.177156,"BND":1.603069,"BOB":8.137303,"BRL":6.122741,"BSD":1.178505,"BTC":3.6118302e-5,"BTN":87.630001,"BWP":13.014628,"BYN":2.960555,"BYR":23072.259728,"BZD":2.3754,"CAD":1.479738,"CDF":2355.489175,"CHF":1.083104,"CLF":0.032162,"CLP":887.434636,"CNY":7.619499,"COP":4555.829571,"CRC":730.671366,"CUC":1.177156,"CUP":31.194637,"CVE":110.200041,"CZK":25.633629,"DJF":209.796333,"DKK":7.437981,"DOP":67.296048,"DZD":158.468795,"EGP":18.444031,"ERN":17.662344,"ETB":52.209225,"EUR":1,"FJD":2.450427,"FKP":0.850803,"GBP":0.855852,"GEL":3.660728,"GGP":0.850803,"GHS":7.017763,"GIP":0.850803,"GMD":60.211669,"GNF":11526.507618,"GTQ":9.133039,"GYD":246.554665,"HKD":9.147439,"HNL":27.993499,"HRK":7.531796,"HTG":111.3663,"HUF":357.731847,"IDR":17058.522316,"ILS":3.853244,"IMP":0.850803,"INR":87.613964,"IQD":1719.386483,"IRR":49564.157699,"ISK":148.380967,"JEP":0.850803,"JMD":181.908771,"JOD":0.834608,"JPY":129.807367,"KES":127.37245,"KGS":99.333493,"KHR":4798.812038,"KMF":493.051413,"KPW":1059.440505,"KRW":1354.653622,"KWD":0.354159,"KYD":0.982121,"KZT":502.433833,"LAK":11246.170784,"LBP":1781.849663,"LKR":235.104814,"LRD":202.058218,"LSL":17.12737,"LTL":3.475836,"LVL":0.71205,"LYD":5.317066,"MAD":10.555278,"MDL":21.34212,"MGA":4471.784043,"MKD":61.578702,"MMK":1939.762279,"MNT":3352.675463,"MOP":9.433739,"MRO":420.244528,"MUR":50.088078,"MVR":18.128343,"MWK":954.013643,"MXN":23.642733,"MYR":4.972897,"MZN":74.878223,"NAD":17.127316,"NGN":484.940994,"NIO":41.375962,"NOK":10.413002,"NPR":140.221256,"NZD":1.687506,"OMR":0.453217,"PAB":1.178505,"PEN":4.649659,"PGK":4.137878,"PHP":59.216808,"PKR":189.556963,"PLN":4.565894,"PYG":8118.91419,"QAR":4.286019,"RON":4.923224,"RSD":117.535717,"RUB":86.760292,"RWF":1175.557051,"SAR":4.415499,"SBD":9.474169,"SCR":17.691092,"SDG":525.597259,"SEK":10.224449,"SGD":1.600426,"SHP":0.850803,"SLL":12071.735708,"SOS":688.636302,"SRD":24.978962,"STD":24249.208694,"SVC":10.311921,"SYP":1480.115766,"SZL":17.158486,"THB":38.752095,"TJS":13.440363,"TMT":4.120046,"TND":3.276616,"TOP":2.660549,"TRY":10.082294,"TTD":7.996786,"TWD":32.990389,"TZS":2729.825029,"UAH":32.038514,"UGX":4181.235311,"USD":1.177156,"UYU":51.752494,"UZS":12490.207469,"VEF":251711552419.43585,"VND":27101.076509,"VUV":129.626902,"WST":3.003697,"XAF":655.570565,"XAG":0.046336,"XAU":0.000651,"XCD":3.181323,"XDR":0.830011,"XOF":655.570565,"XPF":119.540198,"YER":294.465863,"ZAR":17.323738,"ZMK":10595.827918,"ZMW":26.073631,"ZWL":379.044548}})");


    EXPECT_EQ(GetTime(j), 1626952503);
    EXPECT_NE(GetTime(j), 162695253203);

    EXPECT_EQ(GetTime(jj), 1627021804);
    EXPECT_NE(GetTime(jj), 1627021804423);

    EXPECT_EQ(GetRatio(j).at("AED"), float(4.33091));
    EXPECT_NE(GetRatio(j).at("AED"), float(3123));
    EXPECT_EQ(GetRatio(j).at("AFN"), float(93.783272));

    EXPECT_EQ(GetRatio(jj).at("AED"), float(4.323677));
    EXPECT_NE(GetRatio(jj).at("AED"), float(3123));
    EXPECT_EQ(GetRatio(jj).at("AFN"), float(93.705162));

}


namespace {

    class MyTestFixture : public ::testing::Test {
    protected:
        MyTestFixture() : sbuf{nullptr} {
        }

        ~MyTestFixture() override = default;

        void SetUp() override {
            sbuf = cout.rdbuf();
            cout.rdbuf(buffer.rdbuf());
        }

        void TearDown() override {
            cout.rdbuf(sbuf);
            sbuf = nullptr;
        }

        stringstream buffer{};
        streambuf *sbuf;
    };

    TEST_F(MyTestFixture, CurrencyNotMatchTest) {
        string expected{"Given currency is not available."};
        json jjj = json::parse(
                "{\"success\":true,\"timestamp\":1627104304,\"base\":\"EUR\",\"date\":\"2021-07-24\",\"rates\":{\"AED\":4.323647,\"AFN\":93.704246,\"ALL\":122.190789,\"AMD\":569.048659,\"ANG\":2.112659,\"AOA\":753.164313,\"ARS\":113.4341,\"AUD\":1.598276,\"AWG\":2.119423,\"AZN\":2.005794,\"BAM\":1.956811,\"BBD\":2.376391,\"BDT\":99.905374,\"BGN\":1.955237,\"BHD\":0.4439,\"BIF\":2336.603048,\"BMD\":1.17713,\"BND\":1.600534,\"BOB\":8.115067,\"BRL\":6.122023,\"BSD\":1.17699,\"BTC\":3.4967941e-5,\"BTN\":87.592554,\"BWP\":13.091595,\"BYN\":2.95338,\"BYR\":23071.747983,\"BZD\":2.372389,\"CAD\":1.479123,\"CDF\":2357.791814,\"CHF\":1.082491,\"CLF\":0.032516,\"CLP\":897.220722,\"CNY\":7.629455,\"COP\":4577.858567,\"CRC\":729.665722,\"CUC\":1.17713,\"CUP\":31.193945,\"CVE\":110.827253,\"CZK\":25.649957,\"DJF\":209.200007,\"DKK\":7.436501,\"DOP\":67.273442,\"DZD\":158.482945,\"EGP\":18.448,\"ERN\":17.661952,\"ETB\":52.033709,\"EUR\":1,\"FJD\":2.466135,\"FKP\":0.850784,\"GBP\":0.855783,\"GEL\":3.631493,\"GGP\":0.850784,\"GHS\":7.027926,\"GIP\":0.850784,\"GMD\":60.273592,\"GNF\":11594.73091,\"GTQ\":9.121372,\"GYD\":246.013306,\"HKD\":9.145889,\"HNL\":28.228035,\"HRK\":7.537404,\"HTG\":112.874575,\"HUF\":360.072752,\"IDR\":17039.133307,\"ILS\":3.853458,\"IMP\":0.850784,\"INR\":87.610549,\"IQD\":1719.198364,\"IRR\":49563.059029,\"ISK\":148.589574,\"JEP\":0.850784,\"JMD\":181.599936,\"JOD\":0.834632,\"JPY\":130.136476,\"KES\":127.487656,\"KGS\":99.187374,\"KHR\":4796.805159,\"KMF\":492.751086,\"KPW\":1059.417007,\"KRW\":1356.195466,\"KWD\":0.354203,\"KYD\":0.980779,\"KZT\":501.429196,\"LAK\":11247.477553,\"LBP\":1797.477919,\"LKR\":234.792507,\"LRD\":201.999951,\"LSL\":17.469058,\"LTL\":3.475759,\"LVL\":0.712035,\"LYD\":5.314788,\"MAD\":10.561505,\"MDL\":21.302777,\"MGA\":4490.751355,\"MKD\":61.655641,\"MMK\":1937.177265,\"MNT\":3352.6011,\"MOP\":9.41782,\"MRO\":420.235207,\"MUR\":50.74,\"MVR\":18.132206,\"MWK\":947.590056,\"MXN\":23.610227,\"MYR\":4.975145,\"MZN\":74.889455,\"NAD\":17.469053,\"NGN\":484.393382,\"NIO\":41.557073,\"NOK\":10.437263,\"NPR\":140.147887,\"NZD\":1.688005,\"OMR\":0.4533,\"PAB\":1.17689,\"PEN\":4.620828,\"PGK\":4.114115,\"PHP\":59.124,\"PKR\":191.107496,\"PLN\":4.575681,\"PYG\":8133.276547,\"QAR\":4.285976,\"RON\":4.922174,\"RSD\":117.608448,\"RUB\":86.952479,\"RWF\":1165.358699,\"SAR\":4.415075,\"SBD\":9.474008,\"SCR\":17.513,\"SDG\":524.415744,\"SEK\":10.22873,\"SGD\":1.602903,\"SHP\":0.850784,\"SLL\":12065.58289,\"SOS\":688.621448,\"SRD\":25.04584,\"STD\":24248.670845,\"SVC\":10.298162,\"SYP\":1480.082937,\"SZL\":17.469044,\"THB\":38.760581,\"TJS\":13.423071,\"TMT\":4.119955,\"TND\":3.28714,\"TOP\":2.660491,\"TRY\":10.070823,\"TTD\":7.993707,\"TWD\":33.016264,\"TZS\":2729.347808,\"UAH\":31.827853,\"UGX\":4168.771758,\"USD\":1.17713,\"UYU\":51.579853,\"UZS\":12495.235335,\"VEF\":251705969439.0777,\"VND\":27082.22989,\"VUV\":129.624026,\"WST\":3.003631,\"XAF\":656.280365,\"XAG\":0.046748,\"XAU\":0.000653,\"XCD\":3.181253,\"XDR\":0.827708,\"XOF\":655.077084,\"XPF\":119.718358,\"YER\":294.404447,\"ZAR\":17.474907,\"ZMK\":10595.586778,\"ZMW\":24.721791,\"ZWL\":379.036141}}");

        GetUserInput("asc", "EUR", float(100), GetRatio(jjj), GetTime(jjj));

        string actual{buffer.str()};
        string actual_first = actual.substr(0, 32);

        EXPECT_EQ(expected, actual_first);
    }

    TEST_F(MyTestFixture, CurrencyMatchTest) {
        string expected{
                "According to the currency rate at:\nSat Jul 24 13:25:04 2021\n100.000000 USD = 84.952385 EUR\n"};
        json j = json::parse(
                "{\"success\":true,\"timestamp\":1627104304,\"base\":\"EUR\",\"date\":\"2021-07-24\",\"rates\":{\"AED\":4.323647,\"AFN\":93.704246,\"ALL\":122.190789,\"AMD\":569.048659,\"ANG\":2.112659,\"AOA\":753.164313,\"ARS\":113.4341,\"AUD\":1.598276,\"AWG\":2.119423,\"AZN\":2.005794,\"BAM\":1.956811,\"BBD\":2.376391,\"BDT\":99.905374,\"BGN\":1.955237,\"BHD\":0.4439,\"BIF\":2336.603048,\"BMD\":1.17713,\"BND\":1.600534,\"BOB\":8.115067,\"BRL\":6.122023,\"BSD\":1.17699,\"BTC\":3.4967941e-5,\"BTN\":87.592554,\"BWP\":13.091595,\"BYN\":2.95338,\"BYR\":23071.747983,\"BZD\":2.372389,\"CAD\":1.479123,\"CDF\":2357.791814,\"CHF\":1.082491,\"CLF\":0.032516,\"CLP\":897.220722,\"CNY\":7.629455,\"COP\":4577.858567,\"CRC\":729.665722,\"CUC\":1.17713,\"CUP\":31.193945,\"CVE\":110.827253,\"CZK\":25.649957,\"DJF\":209.200007,\"DKK\":7.436501,\"DOP\":67.273442,\"DZD\":158.482945,\"EGP\":18.448,\"ERN\":17.661952,\"ETB\":52.033709,\"EUR\":1,\"FJD\":2.466135,\"FKP\":0.850784,\"GBP\":0.855783,\"GEL\":3.631493,\"GGP\":0.850784,\"GHS\":7.027926,\"GIP\":0.850784,\"GMD\":60.273592,\"GNF\":11594.73091,\"GTQ\":9.121372,\"GYD\":246.013306,\"HKD\":9.145889,\"HNL\":28.228035,\"HRK\":7.537404,\"HTG\":112.874575,\"HUF\":360.072752,\"IDR\":17039.133307,\"ILS\":3.853458,\"IMP\":0.850784,\"INR\":87.610549,\"IQD\":1719.198364,\"IRR\":49563.059029,\"ISK\":148.589574,\"JEP\":0.850784,\"JMD\":181.599936,\"JOD\":0.834632,\"JPY\":130.136476,\"KES\":127.487656,\"KGS\":99.187374,\"KHR\":4796.805159,\"KMF\":492.751086,\"KPW\":1059.417007,\"KRW\":1356.195466,\"KWD\":0.354203,\"KYD\":0.980779,\"KZT\":501.429196,\"LAK\":11247.477553,\"LBP\":1797.477919,\"LKR\":234.792507,\"LRD\":201.999951,\"LSL\":17.469058,\"LTL\":3.475759,\"LVL\":0.712035,\"LYD\":5.314788,\"MAD\":10.561505,\"MDL\":21.302777,\"MGA\":4490.751355,\"MKD\":61.655641,\"MMK\":1937.177265,\"MNT\":3352.6011,\"MOP\":9.41782,\"MRO\":420.235207,\"MUR\":50.74,\"MVR\":18.132206,\"MWK\":947.590056,\"MXN\":23.610227,\"MYR\":4.975145,\"MZN\":74.889455,\"NAD\":17.469053,\"NGN\":484.393382,\"NIO\":41.557073,\"NOK\":10.437263,\"NPR\":140.147887,\"NZD\":1.688005,\"OMR\":0.4533,\"PAB\":1.17689,\"PEN\":4.620828,\"PGK\":4.114115,\"PHP\":59.124,\"PKR\":191.107496,\"PLN\":4.575681,\"PYG\":8133.276547,\"QAR\":4.285976,\"RON\":4.922174,\"RSD\":117.608448,\"RUB\":86.952479,\"RWF\":1165.358699,\"SAR\":4.415075,\"SBD\":9.474008,\"SCR\":17.513,\"SDG\":524.415744,\"SEK\":10.22873,\"SGD\":1.602903,\"SHP\":0.850784,\"SLL\":12065.58289,\"SOS\":688.621448,\"SRD\":25.04584,\"STD\":24248.670845,\"SVC\":10.298162,\"SYP\":1480.082937,\"SZL\":17.469044,\"THB\":38.760581,\"TJS\":13.423071,\"TMT\":4.119955,\"TND\":3.28714,\"TOP\":2.660491,\"TRY\":10.070823,\"TTD\":7.993707,\"TWD\":33.016264,\"TZS\":2729.347808,\"UAH\":31.827853,\"UGX\":4168.771758,\"USD\":1.17713,\"UYU\":51.579853,\"UZS\":12495.235335,\"VEF\":251705969439.0777,\"VND\":27082.22989,\"VUV\":129.624026,\"WST\":3.003631,\"XAF\":656.280365,\"XAG\":0.046748,\"XAU\":0.000653,\"XCD\":3.181253,\"XDR\":0.827708,\"XOF\":655.077084,\"XPF\":119.718358,\"YER\":294.404447,\"ZAR\":17.474907,\"ZMK\":10595.586778,\"ZMW\":24.721791,\"ZWL\":379.036141}}");

        GetUserInput("USD", "EUR", float(100), GetRatio(j), GetTime(j));

        string actual{buffer.str()};

        EXPECT_EQ(expected, actual);
    }

    TEST_F(MyTestFixture, WrongUrlTest) {
        string expected{
                "Error: Request failed on URL : http://7khjkjh\n"
                "Error Code: 6 Error Detail : Couldn't resolve host name\n"};

        GetRequest("http://7khjkjh");

        string actual{buffer.str()};

        EXPECT_EQ(expected, actual);
    }
}

int main(int argc, char **argv) {
    ::testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}




